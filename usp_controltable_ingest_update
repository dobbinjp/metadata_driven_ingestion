SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROC [etl].[UpdateControlTable_Ingest]
@SourceServerName varchar(200),
@SourceDatabaseName varchar(100),
@SourceSchemaName varchar(50),
@SourceTableName varchar(100),
@PipelineRunDateTimeUTC datetime2,
@WatermarkDateTimeUTC  datetime2,
@SourceExtractMethod varchar(20),
@LastRunStatus varchar(20) 
AS
BEGIN

UPDATE etl.ControlTable_Ingest
SET PipelineLastRunDateTimeUTC = @PipelineRunDateTimeUTC
 , DeltaLastWatermarkDateTimeUTC = ISNULL(@WatermarkDateTimeUTC,convert(date,'1900-01-01 00:00:00'))
 , LastRunStatus = @LastRunStatus
WHERE SourceTableName = @SourceTableName
AND SourceDatabaseName = @SourceDatabaseName
AND (SourceServerName = @SourceServerName OR SourceServerName is null)
AND (SourceSchemaName = @SourceSchemaName OR SourceSchemaName is null)
END 
GO
